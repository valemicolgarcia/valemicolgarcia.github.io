---
layout: default
title: Probar Modelo de Detección de Estrés
---

<section class="test-stress-section">
  <div class="test-stress-header">
    <a href="/projects/stress-detection.html" class="back-link"><i class="fas fa-arrow-left"></i> Volver al Proyecto</a>
    <h1 class="test-stress-title">Prueba el Modelo de Detección de Estrés</h1>
    <p class="test-stress-subtitle">Ingresa un texto y descubre si el modelo detecta estrés</p>
  </div>

  <div class="test-stress-container">
    <div class="test-form-card">
      <h2>Ingresa tu texto</h2>
      <form id="stressForm" class="stress-form">
        <textarea 
          id="textInput" 
          class="text-input" 
          placeholder="Escribe aquí tu texto en inglés...&#10;Ejemplo: I am really stressed and anxious"
          rows="6"
          required
        ></textarea>
        <button type="submit" class="predict-btn" id="predictBtn">
          <i class="fas fa-brain"></i> Analizar Texto
        </button>
      </form>
    </div>

    <div id="resultCard" class="result-card hidden">
      <div class="result-header">
        <h3>Resultado del Análisis</h3>
        <button class="close-btn" id="closeBtn">&times;</button>
      </div>
      
      <div class="result-content">
        <div class="prediction-badge" id="predictionBadge">
          <span class="badge-label">Predicción:</span>
          <span class="badge-value" id="badgeValue">-</span>
        </div>
        
        <div class="probability-bars">
          <div class="prob-item">
            <div class="prob-label">
              <span>No Estrés</span>
              <span class="prob-percent" id="noStressProb">0%</span>
            </div>
            <div class="prob-bar">
              <div class="prob-fill no-stress-fill" id="noStressBar"></div>
            </div>
          </div>
          
          <div class="prob-item">
            <div class="prob-label">
              <span>Estrés</span>
              <span class="prob-percent" id="stressProb">0%</span>
            </div>
            <div class="prob-bar">
              <div class="prob-fill stress-fill" id="stressBar"></div>
            </div>
          </div>
        </div>
        
        <div class="result-text">
          <p><strong>Texto analizado:</strong></p>
          <p class="analyzed-text" id="analyzedText"></p>
        </div>
      </div>
    </div>

    <div id="loadingCard" class="loading-card hidden">
      <div class="loading-spinner"></div>
      <p>Analizando texto...</p>
    </div>

    <div id="errorCard" class="error-card hidden">
      <div class="error-icon">⚠️</div>
      <h3>Error</h3>
      <p id="errorMessage"></p>
      <button class="retry-btn" onclick="document.getElementById('errorCard').classList.add('hidden')">Cerrar</button>
    </div>

    <div class="examples-section">
      <h3>Ejemplos para probar</h3>
      <div class="examples-grid">
        <button class="example-btn" onclick="setExample('I am really stressed and anxious')">
          "I am really stressed and anxious"
        </button>
        <button class="example-btn" onclick="setExample('I am relaxed')">
          "I am relaxed"
        </button>
        <button class="example-btn" onclick="setExample('I feel overwhelmed and cannot stop worrying')">
          "I feel overwhelmed and cannot stop worrying"
        </button>
        <button class="example-btn" onclick="setExample('I had a great day today')">
          "I had a great day today"
        </button>
      </div>
    </div>
  </div>
</section>

<script>
// ============================================
// CONFIGURACIÓN - COMPLETAR CON TUS DATOS
// ============================================
// Token de Hugging Face (obtener en https://huggingface.co/settings/tokens)
const HF_TOKEN = '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';  // ✅ Configurado

// ID del modelo en Hugging Face (formato: usuario/modelo)
const MODEL_ID = 'valemicolgarcia/stress-detection';  // ✅ Configurado

// ============================================
// CONFIGURACIÓN DE API
// ============================================
// Detecta automáticamente si está en localhost o producción
const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
const LOCAL_API_URL = 'http://localhost:5000/predict';  // API local Flask
const HF_API_URL = `https://api-inference.huggingface.co/models/${MODEL_ID}`;

// ============================================
// FUNCIONES AUXILIARES
// ============================================
function setExample(text) {
  document.getElementById('textInput').value = text;
}

// ============================================
// FUNCIÓN PRINCIPAL: ANALIZAR ESTRÉS
// ============================================
async function analizarEstres(text) {
  if (isLocalhost) {
    // Modo local: usar API Flask local
    return await analizarEstresLocal(text);
  } else {
    // Modo producción: usar Hugging Face Inference API
    return await analizarEstresHuggingFace(text);
  }
}

// Función para análisis local (Flask API)
async function analizarEstresLocal(text) {
  const response = await fetch(LOCAL_API_URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ text: text })
  });
  
  if (!response.ok) {
    const errorData = await response.json().catch(() => ({}));
    throw new Error(errorData.error || `Error ${response.status}: ${response.statusText}`);
  }
  
  return await response.json();
}

// Función para análisis con Hugging Face Inference API
async function analizarEstresHuggingFace(text, retryCount = 0) {
  // Verificar que el token esté configurado
  if (HF_TOKEN === 'TU_HF_TOKEN_AQUI' || MODEL_ID === 'TU_USUARIO/TU_MODELO') {
    throw new Error('Por favor configura HF_TOKEN y MODEL_ID en el código JavaScript');
  }
  
  const response = await fetch(HF_API_URL, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${HF_TOKEN}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ inputs: text })
  });
  
  if (!response.ok) {
    // Manejar errores específicos de Hugging Face
    if (response.status === 503) {
      const errorData = await response.json().catch(() => ({}));
      const isModelLoading = errorData.error && (
        errorData.error.includes('loading') || 
        errorData.error.includes('model is currently loading')
      );
      
      if (isModelLoading) {
        // Intentar retry automático hasta 3 veces con espera progresiva
        if (retryCount < 3) {
          const waitTime = (retryCount + 1) * 5; // 5s, 10s, 15s
          await new Promise(resolve => setTimeout(resolve, waitTime * 1000));
          return await analizarEstresHuggingFace(text, retryCount + 1);
        } else {
          throw new Error('El modelo está cargando. Por favor espera unos segundos e intenta de nuevo.');
        }
      }
    }
    
    // Otros errores
    const errorData = await response.json().catch(() => ({}));
    let errorMessage = errorData.error || `Error ${response.status}: ${response.statusText}`;
    
    if (response.status === 401) {
      errorMessage = 'Token de Hugging Face inválido. Por favor verifica tu configuración.';
    } else if (response.status === 404) {
      errorMessage = 'Modelo no encontrado. Verifica que el MODEL_ID sea correcto.';
    }
    
    throw new Error(errorMessage);
  }
  
  const hfData = await response.json();
  
  // Convertir formato de Hugging Face al formato esperado
  // HF devuelve: [{label: "LABEL", score: 0.XX}, ...]
  // Necesitamos: {label: "Estrés"|"No Estrés", prediction: 0|1, probability: {no_stress: X, stress: Y}}
  
  // Buscar las etiquetas en la respuesta
  let noStressScore = 0;
  let stressScore = 0;
  let prediction = 0;
  let label = 'No Estrés';
  
  if (Array.isArray(hfData) && hfData.length > 0) {
    // La respuesta es un array de objetos con label y score
    hfData.forEach(item => {
      const itemLabel = item.label ? item.label.toLowerCase() : '';
      const score = item.score || 0;
      
      if (itemLabel.includes('stress') || itemLabel.includes('estrés') || itemLabel === '1' || itemLabel === 'positive') {
        stressScore = score;
      } else {
        noStressScore = score;
      }
    });
    
    // Determinar predicción
    prediction = stressScore > noStressScore ? 1 : 0;
    label = prediction === 1 ? 'Estrés' : 'No Estrés';
    
    // Normalizar probabilidades (asegurar que sumen 1)
    const total = noStressScore + stressScore;
    if (total > 0) {
      noStressScore = noStressScore / total;
      stressScore = stressScore / total;
    } else {
      // Si no hay scores, usar 50/50
      noStressScore = 0.5;
      stressScore = 0.5;
    }
  } else if (hfData.label && hfData.score !== undefined) {
    // Formato alternativo: objeto único con label y score
    const itemLabel = hfData.label.toLowerCase();
    if (itemLabel.includes('stress') || itemLabel.includes('estrés') || itemLabel === '1' || itemLabel === 'positive') {
      stressScore = hfData.score;
      noStressScore = 1 - stressScore;
      prediction = 1;
      label = 'Estrés';
    } else {
      noStressScore = hfData.score;
      stressScore = 1 - noStressScore;
      prediction = 0;
      label = 'No Estrés';
    }
  } else {
    throw new Error('Formato de respuesta inesperado de Hugging Face API');
  }
  
  return {
    text: text,
    prediction: prediction,
    label: label,
    probability: {
      no_stress: noStressScore,
      stress: stressScore
    }
  };
}

// ============================================
// MANEJO DEL FORMULARIO
// ============================================
async function predictStress(event) {
  event.preventDefault();
  
  const text = document.getElementById('textInput').value.trim();
  
  if (!text) {
    alert('Por favor ingresa un texto');
    return;
  }
  
  // Mostrar loading
  document.getElementById('loadingCard').classList.remove('hidden');
  document.getElementById('resultCard').classList.add('hidden');
  document.getElementById('errorCard').classList.add('hidden');
  document.getElementById('predictBtn').disabled = true;
  
  try {
    // Timeout de 60 segundos (HF puede tardar si el modelo está cargando)
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 60000);
    
    const data = await analizarEstres(text);
    
    clearTimeout(timeoutId);
    
    // Mostrar resultado
    displayResult(data);
    
  } catch (error) {
    console.error('Error:', error);
    let errorMessage = 'No se pudo analizar el texto. ';
    
    if (error.name === 'AbortError') {
      errorMessage += 'La solicitud tardó demasiado en responder. Por favor, intenta de nuevo.';
    } else if (error.message) {
      errorMessage += error.message;
    } else {
      errorMessage += 'Asegúrate de que la configuración sea correcta.';
    }
    
    showError(errorMessage);
  } finally {
    document.getElementById('loadingCard').classList.add('hidden');
    document.getElementById('predictBtn').disabled = false;
  }
}

// ============================================
// MOSTRAR RESULTADOS
// ============================================
function displayResult(data) {
  const resultCard = document.getElementById('resultCard');
  const badgeValue = document.getElementById('badgeValue');
  const noStressProb = document.getElementById('noStressProb');
  const stressProb = document.getElementById('stressProb');
  const noStressBar = document.getElementById('noStressBar');
  const stressBar = document.getElementById('stressBar');
  const analyzedText = document.getElementById('analyzedText');
  
  // Actualizar badge
  badgeValue.textContent = data.label;
  badgeValue.className = 'badge-value ' + (data.prediction === 1 ? 'stress' : 'no-stress');
  
  // Actualizar probabilidades
  const noStressPercent = (data.probability.no_stress * 100).toFixed(1);
  const stressPercent = (data.probability.stress * 100).toFixed(1);
  
  noStressProb.textContent = noStressPercent + '%';
  stressProb.textContent = stressPercent + '%';
  
  noStressBar.style.width = noStressPercent + '%';
  stressBar.style.width = stressPercent + '%';
  
  // Actualizar texto analizado
  analyzedText.textContent = data.text;
  
  // Mostrar resultado
  resultCard.classList.remove('hidden');
  resultCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// ============================================
// MANEJO DE ERRORES
// ============================================
function showError(message) {
  const errorCard = document.getElementById('errorCard');
  const errorMessage = document.getElementById('errorMessage');
  errorMessage.textContent = message;
  errorCard.classList.remove('hidden');
  errorCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// ============================================
// EVENT LISTENERS
// ============================================
document.getElementById('stressForm').addEventListener('submit', predictStress);

document.getElementById('closeBtn').addEventListener('click', function() {
  document.getElementById('resultCard').classList.add('hidden');
});
</script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
